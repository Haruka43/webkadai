<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>è‡ªå‹•è²©å£²æ©Ÿ</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <header class="page-header">
      <h1>ğŸ¥¤ è‡ªè²©æ©Ÿã‚¢ãƒ—ãƒª</h1>
      <nav class="links"><a href="/admin">ç®¡ç†è€…ç”»é¢ã¸</a> | <a href="/sales">å£²ä¸Šç®¡ç†ã¸</a></nav>
    </header>

    <main class="vending-machine">
      <div class="machine-frame">
        <div class="machine">
          <div class="control-panel">
            <div class="coin-slot">â—â—</div>
            <div class="display">
              <div class="display-title">æŠ•å…¥é‡‘é¡</div>
              <div id="display-money" class="display-amount">0 å††</div>
            </div>
            <div class="coins">
              <button type="button" class="coin-btn" data-value="10">+10å††</button>
              <button type="button" class="coin-btn" data-value="50">+50å††</button>
              <button type="button" class="coin-btn" data-value="100">+100å††</button>
              <button type="button" class="coin-btn" data-value="500">+500å††</button>
              <button type="button" id="reset-money" class="coin-reset">è¿”å´</button>
            </div>
            <div class="dispense">â€»è³¼å…¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æŠ•å…¥é‡‘é¡ãŒä½¿ã‚ã‚Œã¾ã™</div>
          </div>

          <div class="glass-front"></div>
          <div class="product-grid">
            <% items.forEach((item, idx) => { %>
            <div class="slot <%= item.stock > 0 ? '' : 'sold-out' %> <%= item.placeholder ? 'placeholder' : '' %>">
              <div class="slot-inner">
                <div class="slot-img"><img src="/images/<%= item.image %>" alt="<%= item.name %>" /></div>
                <div class="slot-info">
                  <div class="slot-number">#<%= idx + 1 %></div>
                  <div class="slot-name"><%= item.name %></div>
                  <div class="slot-price"><%= item.price ? item.price + 'å††' : '-' %></div>
                  <% if (item.id && item.stock > 0) { %>
                  <div class="slot-stock">åœ¨åº«: <%= item.stock %></div>
                  <form
                    class="purchase-form"
                    data-price="<%= item.price %>"
                    action="/purchase/<%= item.id %>"
                    method="POST"
                  >
                    <input type="hidden" name="money" value="0" />
                    <button type="submit" class="buy-btn">è³¼å…¥</button>
                  </form>
                  <% } else if (item.placeholder) { %>
                  <div class="sold-text">éå£²å“</div>
                  <% } else { %>
                  <div class="sold-text">å£²åˆ‡</div>
                  <% } %>
                </div>
              </div>
            </div>
            <% }) %>
          </div>

          <div id="tray" class="tray">ã€€</div>
        </div>
      </div>
    </main>

    <script>
      (function () {
        let money = 0;
        const display = document.getElementById('display-money');
        const coinButtons = document.querySelectorAll('.coin-btn');
        const resetBtn = document.getElementById('reset-money');
        const forms = document.querySelectorAll('.purchase-form');
        const tray = document.getElementById('tray');

        function updateDisplay() {
          display.textContent = money + ' å††';
        }

        function createFloatingText(text, x, y) {
          const el = document.createElement('div');
          el.className = 'floating-return';
          el.textContent = text;
          el.style.left = x + 'px';
          el.style.top = y + 'px';
          document.body.appendChild(el);
          requestAnimationFrame(() => el.classList.add('visible'));
          setTimeout(() => el.classList.remove('visible'), 1200);
          setTimeout(() => el.remove(), 1600);
        }

        coinButtons.forEach((btn) => {
          btn.addEventListener('click', function () {
            money += Number(this.dataset.value);
            updateDisplay();
          });
        });

        resetBtn.addEventListener('click', function (e) {
          const refund = money;
          if (refund <= 0) return;
          // show floating animation near coin slot
          const slotRect = document.querySelector('.coin-slot').getBoundingClientRect();
          createFloatingText('è¿”å´: ' + refund + 'å††', slotRect.left, slotRect.top - 24);

          money = 0;
          updateDisplay();
        });

        forms.forEach((form) => {
          const btn = form.querySelector('.buy-btn');
          const slot = form.closest('.slot');
          if (slot && slot.classList.contains('sold-out')) {
            if (btn) btn.disabled = true;
            return;
          }

          form.addEventListener('submit', function (e) {
            const price = Number(form.dataset.price || 0);
            if (money < price) {
              e.preventDefault();
              alert('æŠ•å…¥é‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
              return;
            }

            e.preventDefault();

            // Animate the item image to the tray
            const img = slot.querySelector('.slot-img img');
            const imgRect = img.getBoundingClientRect();
            const trayRect = tray.getBoundingClientRect();

            const clone = img.cloneNode();
            clone.style.position = 'fixed';
            clone.style.left = imgRect.left + 'px';
            clone.style.top = imgRect.top + 'px';
            clone.style.width = imgRect.width + 'px';
            clone.style.height = imgRect.height + 'px';
            clone.style.transition = 'all 600ms cubic-bezier(.2,.8,.2,1)';
            clone.style.zIndex = '1000';
            document.body.appendChild(clone);

            // Force repaint
            void clone.offsetWidth;

            const deltaX = trayRect.left + trayRect.width / 2 - (imgRect.left + imgRect.width / 2);
            const deltaY = trayRect.top + trayRect.height / 2 - (imgRect.top + imgRect.height / 2);

            clone.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.4)`;
            clone.style.opacity = '0.9';

            // Disable buttons while animating
            document.querySelectorAll('.buy-btn').forEach((b) => (b.disabled = true));
            document.querySelectorAll('.coin-btn').forEach((b) => (b.disabled = true));
            resetBtn.disabled = true;

            setTimeout(() => {
              // Remove clone, reduce money, submit with hidden value
              clone.remove();

              money -= price;
              updateDisplay();

              let hidden = form.querySelector('input[name="money"]');
              if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'money';
                form.appendChild(hidden);
              }
              hidden.value = money + price; // pass original money to server

              // re-enable
              document.querySelectorAll('.buy-btn').forEach((b) => (b.disabled = false));
              document.querySelectorAll('.coin-btn').forEach((b) => (b.disabled = false));
              resetBtn.disabled = false;

              form.submit();
            }, 700);
          });
        });

        updateDisplay();
      })();
    </script>
  </body>
</html>
